# CI for Product Catalog service

name : product-catalog-ci

on:
    pull_request:
        branches:
            - main

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set Go 1.22
              uses: actions/setup-go@v4
              with:
                  go-version: 1.22
            
            - name: Build
              run: |
                cd src/product-catalog
                go mod download
                go build -o product-catalog-service main.go

            - name: unit tests
              run: |
                cd src/product-catalog
                go test  ./... 
              

    code-quality:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
         
            - name: Run golangci-lint
              run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest && golangci-lint run --timeout 5m

    docker:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Install Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_TOKEN }}

          
            - name: Docker Push
              uses: docker/build-push-action@v6
              with:
                context: src/product-catalog
                file: src/product-catalog/Dockerfile
                push: true
                tags: ${{ secrets.DOCKER_USERNAME }}/product-catalog:${{github.run_id}}

    Update_k8s_deployment:
        runs-on: ubuntu-latest
        needs: docker
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.GITHUB_TOKEN }}

            - name: Update tag in Kubernetes deployment
              run: |
                  sed -i 's|image: .*|image: '${{ secrets.DOCKER_USERNAME }}/product-catalog:${{ github.run_id }}'|g' kubernetes/productcatalog/deploy.yaml
            - name: Commit changes
              run: |
                  git config --local user.email "sangramgorai@gmail.com"
                  git config --local user.name "Sangram Gorai"
                  git add kubernetes/productcatalog/deploy.yaml
                  git commit -m "[CI]: Update product catalog image tag to ${{ github.run_id }}"
                  git push origin HEAD:main -f